<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Nouveau Workflow - NEXT DRIVE IMPORT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
        }

        .test-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .test-card:hover {
            border-color: #FF6B35;
            transform: translateY(-2px);
        }

        .status-passed {
            background: #10b981;
            color: white;
        }

        .status-failed {
            background: #ef4444;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 8px;
            margin: 4px 0;
            border-left: 3px solid #FF6B35;
            background: rgba(0, 0, 0, 0.3);
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1
                class="text-5xl font-bold mb-4 bg-gradient-to-r from-orange-500 to-yellow-500 bg-clip-text text-transparent">
                üß™ Test Nouveau Workflow
            </h1>
            <p class="text-gray-400 text-lg">Tests complets des nouvelles fonctionnalit√©s</p>
            <div class="mt-4 flex justify-center gap-4">
                <button onclick="runAllTests()"
                    class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">
                    üöÄ Lancer tous les tests
                </button>
                <button onclick="clearLogs()"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">
                    üóëÔ∏è Effacer les logs
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="bg-gray-800 rounded-full h-8 overflow-hidden">
                <div id="progressBar"
                    class="bg-gradient-to-r from-primary to-secondary h-full flex items-center justify-center text-white font-bold transition-all duration-500"
                    style="width: 0%;">
                    <span id="progressText">0%</span>
                </div>
            </div>
        </div>

        <!-- Test Sections -->
        <div id="testSections">
            <!-- Test 1: Quote without account -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    üìù Test 1: Cr√©ation de devis sans compte
                </h2>
                <p class="text-gray-400 mb-4">V√©rifier que le formulaire est accessible et fonctionne sans
                    authentification</p>
                <button onclick="testQuoteWithoutAccount()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 1
                </button>
                <div id="test1-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test1-logs" class="mt-4"></div>
            </div>

            <!-- Test 2: Account creation proposal -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    ‚úâÔ∏è Test 2: Proposition cr√©ation compte apr√®s devis
                </h2>
                <p class="text-gray-400 mb-4">V√©rifier que le message de proposition s'affiche correctement</p>
                <button onclick="testAccountProposal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 2
                </button>
                <div id="test2-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test2-logs" class="mt-4"></div>
            </div>

            <!-- Test 3: Account badge in admin -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    üë§ Test 3: Badge statut compte dans admin
                </h2>
                <p class="text-gray-400 mb-4">V√©rifier l'affichage des badges "‚úì Compte" et "‚ö† Sans compte"</p>
                <button onclick="testAccountBadge()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 3
                </button>
                <div id="test3-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test3-logs" class="mt-4"></div>
            </div>

            <!-- Test 4: Chat API -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    üí¨ Test 4: API Chat Instantan√©
                </h2>
                <p class="text-gray-400 mb-4">Tester l'envoi et la r√©ception de messages</p>
                <button onclick="testChatAPI()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 4
                </button>
                <div id="test4-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test4-logs" class="mt-4"></div>
            </div>

            <!-- Test 5: Chat widget visibility -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    üîç Test 5: Widget Chat Client
                </h2>
                <p class="text-gray-400 mb-4">V√©rifier que le widget s'affiche pour les utilisateurs connect√©s</p>
                <button onclick="testChatWidget()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 5
                </button>
                <div id="test5-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test5-logs" class="mt-4"></div>
            </div>

            <!-- Test 6: Data integrity -->
            <div class="test-section">
                <h2 class="text-2xl font-bold mb-4">
                    üíæ Test 6: Int√©grit√© des donn√©es
                </h2>
                <p class="text-gray-400 mb-4">V√©rifier que les donn√©es sont correctement stock√©es</p>
                <button onclick="testDataIntegrity()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                    ‚ñ∂Ô∏è Ex√©cuter Test 6
                </button>
                <div id="test6-status" class="mt-4 p-4 rounded-lg status-pending inline-block">
                    ‚è≥ En attente
                </div>
                <div id="test6-logs" class="mt-4"></div>
            </div>
        </div>

        <!-- Summary -->
        <div id="testSummary"
            class="mt-12 p-8 bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl border border-gray-700 hidden">
            <h2 class="text-3xl font-bold mb-6 text-center">üìä R√©sum√© des Tests</h2>
            <div class="grid grid-cols-3 gap-6 text-center">
                <div class="p-6 bg-green-900/30 rounded-lg border border-green-700">
                    <div class="text-4xl font-bold text-green-400" id="passedCount">0</div>
                    <div class="text-gray-300 mt-2">Tests R√©ussis</div>
                </div>
                <div class="p-6 bg-red-900/30 rounded-lg border border-red-700">
                    <div class="text-4xl font-bold text-red-400" id="failedCount">0</div>
                    <div class="text-gray-300 mt-2">Tests √âchou√©s</div>
                </div>
                <div class="p-6 bg-blue-900/30 rounded-lg border border-blue-700">
                    <div class="text-4xl font-bold text-blue-400" id="totalCount">6</div>
                    <div class="text-gray-300 mt-2">Total Tests</div>
                </div>
            </div>
            <div class="mt-6 text-center">
                <div class="text-5xl font-bold" id="successRate">0%</div>
                <div class="text-gray-400 mt-2">Taux de R√©ussite</div>
            </div>
        </div>
    </div>

    <script>
        let totalTests = 6;
        let completedTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function log(testId, message, type = 'info') {
            const logsDiv = document.getElementById(`test${testId}-logs`);
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            const timestamp = new Date().toLocaleTimeString();

            logEntry.innerHTML = `[${timestamp}] ${icon} ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateStatus(testId, status) {
            const statusDiv = document.getElementById(`test${testId}-status`);
            statusDiv.className = `mt-4 p-4 rounded-lg status-${status} inline-block`;

            if (status === 'passed') {
                statusDiv.innerHTML = '‚úÖ R√©ussi';
                passedTests++;
            } else if (status === 'failed') {
                statusDiv.innerHTML = '‚ùå √âchou√©';
                failedTests++;
            } else {
                statusDiv.innerHTML = '‚è≥ En attente';
            }

            completedTests++;
            updateProgress();
        }

        function updateProgress() {
            const percentage = Math.round((completedTests / totalTests) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';

            if (completedTests === totalTests) {
                showSummary();
            }
        }

        function showSummary() {
            document.getElementById('testSummary').classList.remove('hidden');
            document.getElementById('passedCount').textContent = passedTests;
            document.getElementById('failedCount').textContent = failedTests;
            document.getElementById('successRate').textContent = Math.round((passedTests / totalTests) * 100) + '%';
        }

        function clearLogs() {
            for (let i = 1; i <= totalTests; i++) {
                const logsDiv = document.getElementById(`test${i}-logs`);
                if (logsDiv) logsDiv.innerHTML = '';
                updateStatus(i, 'pending');
            }
            completedTests = 0;
            passedTests = 0;
            failedTests = 0;
            document.getElementById('testSummary').classList.add('hidden');
            updateProgress();
        }

        // ========== TEST 1: Quote without account ==========
        async function testQuoteWithoutAccount() {
            log(1, 'D√©marrage du test de cr√©ation de devis sans compte...', 'info');

            try {
                // Test 1: V√©rifier que le formulaire est accessible
                log(1, 'Test: V√©rification formulaire accessible sur index.html', 'info');

                const response = await fetch('/');
                const html = await response.text();

                if (!html.includes('id="devisForm"')) {
                    throw new Error('Formulaire devis introuvable');
                }
                log(1, '‚úì Formulaire devis trouv√©', 'success');

                // Test 2: V√©rifier que devis-flow.js est charg√©
                if (!html.includes('devis-flow.js')) {
                    throw new Error('Script devis-flow.js non inclus');
                }
                log(1, '‚úì Script devis-flow.js inclus', 'success');

                // Test 3: Envoyer un devis test
                log(1, 'Test: Envoi d\'un devis test sans authentification', 'info');

                const devisData = {
                    nom: 'Test User ' + Date.now(),
                    email: 'test' + Date.now() + '@example.com',
                    telephone: '0612345678',
                    vehicule: {
                        marque: 'BMW',
                        modele: 'M3',
                        budget: 35000
                    },
                    message: 'Test quote without account',
                    rgpd_consent: true
                };

                const devisResponse = await fetch('/api/submit-devis.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(devisData)
                });

                const devisResult = await devisResponse.json();

                if (!devisResult.success) {
                    throw new Error('√âchec de soumission: ' + devisResult.message);
                }

                log(1, '‚úì Devis soumis avec succ√®s: ' + devisResult.devis_id, 'success');
                log(1, '‚úì Has account: ' + (devisResult.has_account ? 'Oui' : 'Non'), 'info');

                updateStatus(1, 'passed');

            } catch (error) {
                log(1, 'Erreur: ' + error.message, 'error');
                updateStatus(1, 'failed');
            }
        }

        // ========== TEST 2: Account creation proposal ==========
        async function testAccountProposal() {
            log(2, 'D√©marrage du test de proposition de cr√©ation de compte...', 'info');

            try {
                // V√©rifier la pr√©sence du modal dans index.html
                const response = await fetch('/');
                const html = await response.text();

                if (!html.includes('accountCreationProposal') || !html.includes('accountCreationForm')) {
                    throw new Error('√âl√©ments de proposition de compte introuvables');
                }
                log(2, '‚úì Modal de cr√©ation de compte pr√©sent', 'success');

                if (!html.includes('showAccountCreation') || !html.includes('skipAccountCreation')) {
                    throw new Error('Fonctions de gestion du modal introuvables');
                }
                log(2, '‚úì Fonctions JavaScript de gestion pr√©sentes', 'success');

                // V√©rifier le message
                if (!html.includes('Cr√©ez votre compte maintenant') || !html.includes('chat instantan√©')) {
                    throw new Error('Message de proposition incorrect');
                }
                log(2, '‚úì Message de proposition correct', 'success');

                updateStatus(2, 'passed');

            } catch (error) {
                log(2, 'Erreur: ' + error.message, 'error');
                updateStatus(2, 'failed');
            }
        }

        // ========== TEST 3: Account badge ==========
        async function testAccountBadge() {
            log(3, 'D√©marrage du test des badges de statut compte...', 'info');

            try {
                // V√©rifier la pr√©sence du code dans admin-script.js
                const response = await fetch('/assets/js/admin-script.js');
                const script = await response.text();

                if (!script.includes('has_account')) {
                    throw new Error('D√©tection de compte non impl√©ment√©e');
                }
                log(3, '‚úì Logique de d√©tection de compte pr√©sente', 'success');

                if (!script.includes('‚úì Compte') || !script.includes('‚ö† Sans compte')) {
                    throw new Error('Badges de statut introuvables');
                }
                log(3, '‚úì Badges de statut pr√©sents dans le code', 'success');

                // V√©rifier les classes CSS
                if (!script.includes('bg-green-600') || !script.includes('bg-gray-600')) {
                    throw new Error('Classes CSS de badges introuvables');
                }
                log(3, '‚úì Classes CSS de badges correctes', 'success');

                updateStatus(3, 'passed');

            } catch (error) {
                log(3, 'Erreur: ' + error.message, 'error');
                updateStatus(3, 'failed');
            }
        }

        // ========== TEST 4: Chat API ==========
        async function testChatAPI() {
            log(4, 'D√©marrage du test de l\'API chat...', 'info');

            try {
                // Test 1: Envoyer un message
                log(4, 'Test: Envoi d\'un message', 'info');

                const messageData = {
                    action: 'send_message',
                    user_id: 'test_user_' + Date.now(),
                    user_email: 'test@example.com',
                    user_name: 'Test User',
                    message: 'Test message ' + Date.now(),
                    is_admin: false
                };

                const sendResponse = await fetch('/api/chat.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });

                const sendResult = await sendResponse.json();

                if (!sendResult.success) {
                    throw new Error('√âchec d\'envoi du message');
                }
                log(4, '‚úì Message envoy√© avec succ√®s', 'success');

                // Test 2: R√©cup√©rer les messages
                log(4, 'Test: R√©cup√©ration des messages', 'info');

                const getResponse = await fetch('/api/chat.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'get_messages',
                        user_id: messageData.user_id,
                        is_admin: false
                    })
                });

                const getResult = await getResponse.json();

                if (!getResult.success || !getResult.messages) {
                    throw new Error('√âchec de r√©cup√©ration des messages');
                }
                log(4, `‚úì Messages r√©cup√©r√©s (${getResult.messages.length} message(s))`, 'success');

                updateStatus(4, 'passed');

            } catch (error) {
                log(4, 'Erreur: ' + error.message, 'error');
                updateStatus(4, 'failed');
            }
        }

        // ========== TEST 5: Chat widget ==========
        async function testChatWidget() {
            log(5, 'D√©marrage du test du widget chat...', 'info');

            try {
                // V√©rifier la pr√©sence du script
                const response = await fetch('/pages/client.html');
                const html = await response.text();

                if (!html.includes('chat-client.js')) {
                    throw new Error('Script chat-client.js non inclus');
                }
                log(5, '‚úì Script chat-client.js inclus dans client.html', 'success');

                // V√©rifier le contenu du script
                const scriptResponse = await fetch('/assets/js/chat-client.js');
                const script = await scriptResponse.text();

                if (!script.includes('initChat')) {
                    throw new Error('Fonction initChat introuvable');
                }
                log(5, '‚úì Fonction d\'initialisation pr√©sente', 'success');

                if (!script.includes('chatWidget') || !script.includes('chatToggle')) {
                    throw new Error('√âl√©ments du widget introuvables');
                }
                log(5, '‚úì √âl√©ments du widget pr√©sents', 'success');

                if (!script.includes('startChatPolling')) {
                    throw new Error('Syst√®me de polling introuvable');
                }
                log(5, '‚úì Syst√®me de polling impl√©ment√©', 'success');

                updateStatus(5, 'passed');

            } catch (error) {
                log(5, 'Erreur: ' + error.message, 'error');
                updateStatus(5, 'failed');
            }
        }

        // ========== TEST 6: Data integrity ==========
        async function testDataIntegrity() {
            log(6, 'D√©marrage du test d\'int√©grit√© des donn√©es...', 'info');

            try {
                // Test 1: Cr√©er un devis
                log(6, 'Test: Cr√©ation d\'un devis et v√©rification du champ has_account', 'info');

                const testEmail = 'integrity_test_' + Date.now() + '@example.com';
                const devisData = {
                    nom: 'Integrity Test',
                    email: testEmail,
                    telephone: '0698765432',
                    vehicule: {
                        marque: 'Audi',
                        modele: 'RS6',
                        budget: 45000
                    },
                    message: 'Test d\'int√©grit√©',
                    rgpd_consent: true
                };

                const devisResponse = await fetch('/api/submit-devis.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(devisData)
                });

                const devisResult = await devisResponse.json();

                if (!devisResult.success) {
                    throw new Error('√âchec de cr√©ation du devis: ' + (devisResult.message || 'Erreur inconnue'));
                }
                log(6, '‚úì Devis cr√©√© avec succ√®s', 'success');

                // V√©rifier que has_account est pr√©sent
                if (typeof devisResult.has_account === 'undefined') {
                    throw new Error('Champ has_account manquant');
                }
                log(6, `‚úì Champ has_account pr√©sent: ${devisResult.has_account}`, 'success');

                // Test 2: V√©rifier le chat
                log(6, 'Test: Cr√©ation et r√©cup√©ration d\'un message chat', 'info');

                const chatData = {
                    action: 'send_message',
                    user_id: 'integrity_test',
                    user_email: testEmail,
                    user_name: 'Integrity Test',
                    message: 'Message de test d\'int√©grit√©',
                    is_admin: false
                };

                const chatResponse = await fetch('/api/chat.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatData)
                });

                const chatResult = await chatResponse.json();

                if (!chatResult.success || !chatResult.data) {
                    throw new Error('√âchec de cr√©ation du message chat');
                }
                log(6, '‚úì Message chat cr√©√© avec succ√®s', 'success');
                log(6, `‚úì ID du message: ${chatResult.data.id}`, 'info');

                updateStatus(6, 'passed');

            } catch (error) {
                log(6, 'Erreur: ' + error.message, 'error');
                updateStatus(6, 'failed');
            }
        }

        // ========== RUN ALL TESTS ==========
        async function runAllTests() {
            clearLogs();

            await testQuoteWithoutAccount();
            await new Promise(r => setTimeout(r, 500));

            await testAccountProposal();
            await new Promise(r => setTimeout(r, 500));

            await testAccountBadge();
            await new Promise(r => setTimeout(r, 500));

            await testChatAPI();
            await new Promise(r => setTimeout(r, 500));

            await testChatWidget();
            await new Promise(r => setTimeout(r, 500));

            await testDataIntegrity();
        }
    </script>
</body>

</html>